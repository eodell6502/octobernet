<!doctype html>
<html lang="us">
<head>  <meta charset="utf-8">
<title>OctoberNet: Sysop Control Panel</title>
<style type="text/css">

div.shown  { display: block; }
.hidden { display: none; }

</style>
<script src="js/jquery-3.6.3.min.js"></script>
<!-- <script src="js/GQuery.js"></script> -->
<script type="module">
import GQuery from "./js/GQuery.mjs";
var apiUrl = "http://192.168.1.140/on";

var pg = { // page global state
    umgr: {
        type: "all",
        users: null,
    }
};

$(document).ready(function() {
    $("#logoutLink").on("click", logout);
    $("#usersLink").on("click", () => { xBlock("panel", "usersPanel"); });
    $("#forumsLink").on("click", () => { xBlock("panel", "forumsPanel"); });
    $("#hostsLink").on("click", () => { xBlock("panel", "hostsPanel"); });
    $("#configLink").on("click", () => { xBlock("panel", "configPanel"); });
    $("#umgrAll").on("click", () => { usersFilter("all"); });
    $("#umgrNoobs").on("click", () => { usersFilter("noob"); });
    $("#umgrUsers").on("click", () => { usersFilter("user"); });
    $("#umgrSysops").on("click", () => { usersFilter("sysop"); });
    $("#umgrRefresh").on("click", () => { usersLoad(); });
    $("#umgrCancel").on("click", () => { document.userEditForm.reset(); });
    $("#umgrSave").on("click", () => { userSave(); });
    $("#configSubmit").on("click", () => { configSave(); });

    usersLoad();
    configLoad();
});

//==============================================================================

function xBlock(classname, id) {
    $("." + classname).addClass("hidden");
    $("#" + id).removeClass("hidden");
}

//==============================================================================

async function logout() {
    var g = new GQuery(apiUrl);
    var res = await g.req("userLogout", { _loginToken: localStorage.loginToken } );
    localStorage.clear();
    window.location = "index.html";
}

//==============================================================================

async function usersFilter(type) {
    if(type !== undefined)
        pg.umgr.type = type;

    $("#umgrListBody tr").removeClass("hidden");
    switch(pg.umgr.type) {
        case "noob":
            $("#umgrListBody tr.noob").removeClass("hidden");
            $("#umgrListBody tr.user").addClass("hidden");
            $("#umgrListBody tr.sysop").addClass("hidden");
            break;
        case "user":
            $("#umgrListBody tr.noob").addClass("hidden");
            $("#umgrListBody tr.user").removeClass("hidden");
            $("#umgrListBody tr.sysop").addClass("hidden");
            break;
        case "sysop":
            $("#umgrListBody tr.noob").addClass("hidden");
            $("#umgrListBody tr.user").addClass("hidden");
            $("#umgrListBody tr.sysop").removeClass("hidden");
            break;
        default:
            return;
    }
}

//==============================================================================

async function usersLoad() {
    var g = new GQuery(apiUrl);
    var res = await g.req("usersGet", { _loginToken: localStorage.loginToken } );
    pg.umgr.users = res.users;
    var rows = [ ];
    for(var i = 0; i < res.users.length; i++) {
        var u = res.users[i];
        rows.push(
            "<tr class=\"uline " + u.type + "\" id=\"ul" + u.id + "\"><td>" + u.id + "</td>"
            + "<td>" + u.type + "</td>"
            + "<td>" + u.displayName + "</td>"
            + "<td>" + u.lastActive + "</td>"
            + "<td>" + u.suspendedUntil + "</td>"
            + "</tr>"
        );
    }
    $(".uline").off();
    $("#umgrListBody").html(rows.join("\n"));
    $(".uline").on("click", function() {
        userLoad(parseInt(this.id.substr(2)));
    });
    usersFilter();
}

//==============================================================================

async function userLoad(id) {
    var g = new GQuery(apiUrl);
    var res = await g.req("userGet", { _loginToken: localStorage.loginToken, userId: id } );
    if(res._errmsg) {
        alert(res._errmsg);
        return;
    }
    var u = res.user;
    document.userEditForm.reset();
    document.userEditForm.id.value = u.id;
    document.userEditForm.username.value = u.username;
    document.userEditForm.displayName.value = u.displayName;
    document.userEditForm.email.value = u.email;
    document.userEditForm.type.value = u.type;
    if(u.suspendedUntil) {
        document.userEditForm.suspendedDate.value = u.suspendedUntil.substr(0, 10);
        document.userEditForm.suspendedTime.value = u.suspendedUntil.substr(11, 5);
    } else {
        document.userEditForm.suspendedDate.value = "";
        document.userEditForm.suspendedTime.value = "";
    }
    document.userEditForm.createdDate.value = u.created.substr(0, 10);
    document.userEditForm.createdTime.value = u.created.substr(11, 5);
    if(u.lastActive) {
        document.userEditForm.lastActiveDate.value = u.lastActive.substr(0, 10);
        document.userEditForm.lastActiveTime.value = u.lastActive.substr(11, 5);
    } else {
        document.userEditForm.lastActiveDate.value = "";
        document.userEditForm.lastActiveTime.value = "";
    }

}

//==============================================================================

async function userSave(id) {

    var user = {
        id:             parseInt(document.userEditForm.id.value),
        username:       document.userEditForm.username.value.trim(),
        displayName:    document.userEditForm.displayName.value.trim(),
        email:          document.userEditForm.email.value.trim(),
        password:       document.userEditForm.password.value,
        type:           document.userEditForm.type.value,
        suspendedUntil: datetimeAssemble(document.userEditForm.suspendedDate.value, document.userEditForm.suspendedTime.value),
    };

    if(!user.username.length) {
        $("#userError").html("A username must be supplied");
        return;
    }

    if(!user.displayName.length) {
        $("#userError").html("A display name must be supplied");
        return;
    }

    if(!user.email.length) {
        $("#userError").html("An email address must be supplied.");
        return;
    }

    if(user.id) { // edit existing

        // If a password is not supplied, it will not be updated.

        if(user.password.length) {
            if(user.password != document.userEditForm.password2.value) {
                $("#userError").html("Passwords must match.");
                return;
            }
        } else {
            user.password = null;
        }

    } else {      // create new

        // For new users, a password must be provided.

        if(!user.password.length) {
            $("#userError").html("A password must be supplied.");
            return;
        }

        if(user.password != document.userEditForm.password2.value) {
            $("#userError").html("Passwords must match.");
            return;
        }

    }

    var g = new GQuery(apiUrl);
    user._loginToken = localStorage.loginToken;
    var res = await g.req("userUpsert", user );
    if(res._errcode) {
        $("#userError").html(res._errmsg);
        return;
    }

    document.userEditForm.reset();
    $("#userError").html("");
    await usersLoad();
}


//==============================================================================

function datetimeAssemble(date, time) {
    if(!date || !time)
        return null;
    else
        return date + " " + time;
}


//==============================================================================

async function configSave() {
    var fields = [
        "bbsApiUrl", "bbsGuid", "bbsLdesc", "bbsName", "bbsPrivateKey",
        "bbsPublicKey", "bbsPublicUrl", "bbsSdesc", "bbsUtcOffset",
        "emailAutoAddress", "emailHost", "emailPassword", "emailPort",
        "emailUsername", "mainUrl", "maxFieldCount",
        "maxFieldSize", "maxFileCount", "maxFileSize", "port",
        "pwdMinLength", "sessionLifetime", "sysopEmail",
        "sysopName", "verificationLifetime",
    ];
    var args = { _loginToken: localStorage.loginToken };
    for(var f of fields)
        args[f] = document.configForm[f].value;

    var checkboxes = [ "emailSecure", "pwdHasLowercase", "pwdHasNumbers",
        "pwdHasSpecialChars", "pwdHasUppercase" ];
    for(var c of checkboxes)
        args[c] = document.configForm[c].checked;

    var g = new GQuery(apiUrl);
    var res = await g.req("configSave", args );
    if(res._errmsg) {
        alert(res._errmsg);
        return;
    }

}

//==============================================================================

async function configLoad() {

    var g = new GQuery(apiUrl);
    var res = await g.req("configLoad", { _loginToken: localStorage.loginToken } );
    if(res._errmsg) {
        alert(res._errmsg);
        return;
    }
    res = res.config;

    document.configForm.bbsApiUrl.value = res.bbsApiUrl;
    document.configForm.bbsGuid.value = res.bbsGuid;
    document.configForm.bbsLdesc.value = res.bbsLdesc;
    document.configForm.bbsName.value = res.bbsName;
    document.configForm.bbsPrivateKey.value = res.bbsPrivateKey;
    document.configForm.bbsPublicKey.value = res.bbsPublicKey;
    document.configForm.bbsPublicUrl.value = res.bbsPublicUrl;
    document.configForm.bbsSdesc.value = res.bbsSdesc;
    document.configForm.bbsUtcOffset.value = res.bbsUtcOffset;
    document.configForm.emailAutoAddress.value = res.emailAutoAddress;
    document.configForm.emailHost.value = res.emailHost;
    document.configForm.emailPassword.value = res.emailPassword;
    document.configForm.emailPort.value = res.emailPort;
    document.configForm.emailSecure.checked = res.emailSecure;
    document.configForm.emailUsername.value = res.emailUsername;
    document.configForm.mainUrl.value = res.mainUrl;
    document.configForm.maxFieldCount.value = res.maxFieldCount;
    document.configForm.maxFieldSize.value = res.maxFieldSize;
    document.configForm.maxFileCount.value = res.maxFileCount;
    document.configForm.maxFileSize.value = res.maxFileSize;
    document.configForm.port.value = res.port;
    document.configForm.pwdHasLowercase.checked = res.pwdHasLowercase;
    document.configForm.pwdHasNumbers.checked = res.pwdHasNumbers;
    document.configForm.pwdHasSpecialChars.checked = res.pwdHasSpecialChars;
    document.configForm.pwdHasUppercase.checked = res.pwdHasUppercase;
    document.configForm.pwdMinLength.value = res.pwdMinLength;
    document.configForm.sessionLifetime.value = res.sessionLifetime;
    document.configForm.sysopEmail.value = res.sysopEmail;
    document.configForm.sysopName.value = res.sysopName;
    document.configForm.verificationLifetime.value = res.verificationLifetime;


}




</script>
</head><body>
<h1>Sysop Control Panel</h1>

<p>
    <span id="usersLink">Users</span> |
    <span id="forumsLink">Forums</span> |
    <span id="hostsLink">Hosts</span> |
    <span id="configLink">Config</span> |
    <span id="logoutLink">Log Out</span>
</p>

<!-- User Editor -->

<hr/> <!-- tmp -->

<div class="panel" id="usersPanel">
    <h2>User Manager</h2>

    <div id="userPanel usersTable">

        <button id="umgrAll">All</button>
        <button id="umgrNoobs">Noobs</button>
        <button id="umgrUsers">Users</button>
        <button id="umgrSysops">Sysops</button>
        <button id="umgrRefresh">Refresh</button>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Display Name</th>
                    <th>Last Active</th>
                    <th>Suspension</th>
                </tr>
            </thead>
            <tbody id="umgrListBody">
            </tbody>
        </table>
    </div>

    <div id="userPanel userEditor">
        <div id="userError"></div>
        <form name="userEditForm" id="userEditForm" onsubmit="return false;">
            <input type="hidden" name="id">
            Username:          <input type="text" name="username" size="20" maxlength="64"><br/>
            Display Name:      <input type="text" name="displayName" size="20" maxlength="64"><br/>
            Email:             <input type="text" name="email" size="20" maxlength="64"><br/>
            Password:          <input type="password" name="password" size="20" maxlength="64"><br/>
            Confirm:           <input type="password" name="password2" size="20" maxlength="64"><br/>
            Type:              <select name="type">
                                   <option value="noob">noob</option>
                                   <option value="user">user</option>
                                   <option value="sysop">sysop</option>
                               </select><br/>
            Suspended Until:   <input type="date" name="suspendedDate"> <input type="time" name="suspendedTime"><br/>
            Created:           <input type="date" name="createdDate" readonly> <input type="time" name="createdTime" readonly><br/>
            Last Active:       <input type="date" name="lastActiveDate" readonly> <input type="time" name="lastActiveTime" readonly><br/>
            <button id="umgrSave">Save</button><br/>
            <button id="umgrCancel">Cancel</button>
        </form>
    </div>

</div>

<!-- Forum Editor -->

<div class="panel hidden" id="forumsPanel">
    <h2>Forum Manager</h2>
</div>

<!-- Hosts Viewer -->

<div class="panel hidden" id="hostsPanel">
    <h2>Hosts Viewer</h2>
</div>

<!-- System Config -->

<div class="panel hidden" id="configPanel">
    <h2>System Configuration</h2>
    <div id="configError"></div>
    <form name="configForm" id="configForm" onsubmit="return false;">

bbsApiUrl:             <input type="text" name="bbsApiUrl" size="40" maxlength="128"><br/>
bbsGuid:               <input type="text" name="bbsGuid"   size="40" maxlength="64"><br/>
bbsLdesc:              <textarea name="bbsLdesc"></textarea><br/>
bbsName:               <input type="text" name="bbsName" size="40" maxlength="64"><br/>
bbsPrivateKey:         <textarea name="bbsPrivateKey"></textarea><br/>
bbsPublicKey:          <textarea name="bbsPublicKey"></textarea><br/>
bbsPublicUrl:          <input type="text" name="bbsPublicUrl" size="40" maxlength="256"><br/>
bbsSdesc:              <input type="text" name="bbsSdesc" size="40" maxlength="80"><br/>
bbsUtcOffset:          <select name="bbsUtcOffset">
                         <option value="-12">-12</option>
                         <option value="-11">-11</option>
                         <option value="-10">-10</option>
                         <option value="-9">-9</option>
                         <option value="-8">-8</option>
                         <option value="-7">-7</option>
                         <option value="-6">-6</option>
                         <option value="-5">-5</option>
                         <option value="-4">-4</option>
                         <option value="-3">-3</option>
                         <option value="-2">-2</option>
                         <option value="-1">-1</option>
                         <option value="0" selected>0</option>
                         <option value="+1">+1</option>
                         <option value="+2">+2</option>
                         <option value="+3">+3</option>
                         <option value="+4">+4</option>
                         <option value="+5">+5</option>
                         <option value="+6">+6</option>
                         <option value="+7">+7</option>
                         <option value="+8">+8</option>
                         <option value="+9">+9</option>
                         <option value="+10">+10</option>
                         <option value="+11">+11</option>
                         <option value="+12">+12</option>
                      </select><br/>
emailAutoAddress:      <input type="text" name="emailAutoAddress" size="40" maxlength="64"><br/>
emailHost:             <input type="text" name="emailHost" size="40" maxlength="64"><br/>
emailPassword:         <input type="text" name="emailPassword" size="40" maxlength="64"><br/>
emailPort:             <input type="text" name="emailPort" size="5" maxlength="5"><br/>
emailSecure:           <input type="checkbox" name="emailSecure"><br/>
emailUsername:         <input type="text" name="emailUsername" size="40" maxlength="64"><br/>
mainUrl:               <input type="text" name="mainUrl" size="40" maxlength="256"><br/>
maxFieldCount:         <input type="text" name="maxFieldCount" size="20" maxlength="20"><br/>
maxFieldSize:          <input type="text" name="maxFieldSize" size="20" maxlength="20"><br/>
maxFileCount:          <input type="text" name="maxFileCount" size="20" maxlength="20"><br/>
maxFileSize:           <input type="text" name="maxFileSize" size="20" maxlength="20"><br/>
port:                  <input type="text" name="port" size="5" maxlength="5"><br/>
pwdHasLowercase:       <input type="checkbox" name="pwdHasLowercase"><br/>
pwdHasNumbers:         <input type="checkbox" name="pwdHasNumbers"><br/>
pwdHasSpecialChars:    <input type="checkbox" name="pwdHasSpecialChars"><br/>
pwdHasUppercase:       <input type="checkbox" name="pwdHasUppercase"><br/>
pwdMinLength:          <input type="text" name="pwdMinLength" size="5" maxlength="5"><br/>
sessionLifetime:       <input type="text" name="sessionLifetime" size="20" maxlength="20"><br/>
sysopEmail:            <input type="text" name="sysopEmail" size="40" maxlength="64"><br/>
sysopName:             <input type="text" name="sysopName" size="40" maxlength="64"><br/>
verificationLifetime:  <input type="text" name="verificationLifetime" size="20" maxlength="20"><br/>
<button id="configSubmit">Save</button>
    </form>

</div>


</body>
</html>
